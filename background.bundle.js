(()=>{"use strict";const e="CMD_ADD_IMGS",t="STORAGE_APP_CONFIG",a="dl_current_tab",o="search_img",s="search_img_1688",n="search_img_alibaba",r="search_img_aliexpress",i="search_img_taobao",c="search_img_baidu",l="search_img_google",m="Fatkun";async function d(){let e=(await chrome.storage.local.get("clientId")).clientId;return e||(e=self.crypto.randomUUID(),await chrome.storage.local.set({clientId:e})),e}async function u(){let{sessionData:e}=await chrome.storage.session.get("sessionData");const t=Date.now();if(e&&e.timestamp){(t-e.timestamp)/6e4>30?e=null:(e.timestamp=t,await chrome.storage.session.set({sessionData:e}))}return e||(e={session_id:t.toString(),timestamp:t.toString()},await chrome.storage.session.set({sessionData:e})),e.session_id}async function g(e){{let a=[];for(var t of e)a.push({name:t.name,params:{ext_version:chrome.runtime.getManifest().version,session_id:await u(),engagement_time_msec:100,host:location.host,url:location.href,...t.params}});fetch("https://www.google-analytics.com/mp/collect?measurement_id=G-TL2X2T0H82&api_secret=kSqA9hkGQ5GLdUilzS5jLg",{method:"POST",body:JSON.stringify({client_id:await d(),events:a})})}}const h={output:{},saveDir:{dirType:"useDocTitle",fixedDir:m},extraFeatures:["cutoutImage","translateImage"],webpTo:{enabled:!0,type:"jpeg"},avifTo:{enabled:!0,type:"jpeg"},rename:{enabled:!1,rule:""},enableDragDownload:!0,dragTo:"filter",dlBtnType:"download",colorMode:"light",noTextOnButton:!1,zip:{enabled:!1,folderStructure:"grouped",flatWithPrefix:!1},record_page_info:!1,pageContent:{showBtn:!0},contextMenus:[{id:a,visible:!0},{id:o,visible:!0}],previewSize:120,downloadSize:{type:"origin",width:800},enableNewTab:true,showSimilar:!1,enableFanliNoti:!1,showFloating:!0,dl_shortcut:"z",search_img_page_in_sidePanel:!1,dlSingleMethods:{doubleClick:!0,middleClick:!0,ctrlClick:!0},searchImgPopBtn:!0};async function w(e){return new Promise(t=>{var a=new FileReader;a.onload=function(e){var a;t(null===(a=e.target)||void 0===a?void 0:a.result)},a.readAsDataURL(e)})}class f{constructor(e,t){this.cmd=e,this.data=t}}async function p(e){let t=await fetch(`${e}m/md5s.json?_=${Date.now()}`).then(e=>e.json());for(var a of t){let t=`mfile_${a.file}`,o=(await chrome.storage.local.get(t))[t],s="";if(o&&o.md5==a.md5)s=o.text;else{let o=await fetch(`${e}${a.file}?_=${a.md5}`).then(e=>e.text());await chrome.storage.local.set({[t]:{md5:a.md5,text:o}}),s=o}if("m/smartRules.json"==a.file)chrome.storage.local.set({smartRules:JSON.parse(s)});else if("m/netRules.json"==a.file){let e=JSON.parse(s);chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:e.map(e=>e.id)}).then(()=>{chrome.declarativeNetRequest.updateSessionRules({addRules:e})})}else if("m/hdRules.json"==a.file){let e=JSON.parse(s);chrome.storage.local.set({commonRules_mv3:e})}else if("m/reviewRules.json"==a.file){let e=JSON.parse(s);chrome.storage.local.set({reviewRules:e})}}}async function b(e,t){let a=await async function(e){const t=await chrome.storage.local.get("simgConfigV2");if(t.simgConfigV2&&t.simgConfigV2.sites){const a=t.simgConfigV2.sites.find(t=>t.id==e);if(a&&a.url)return a.url}let a="";return"1688"==e?a="https://www.1688.com":"alibaba"==e?a="https://offer.alibaba.com/cps/hfj5ca47?bm=cps&src=saf&pid=image-search":"aliexpress"==e?a="https://s.click.aliexpress.com/e/_opFB1sj":"taobao"==e?a="https://www.taobao.com":"s.taobao"==e?a="https://s.taobao.com/search":"baidu"==e?a="https://www.baidu.com/":"google"==e?a="https://www.google.com/":"madeInChina"==e?a="https://www.made-in-china.com":"vvic"==e?a="https://tusou.vvic.com/":"bing"==e&&(a="https://www.bing.com/"),a}(t);fetch(e).then(e=>e.blob()).then(async e=>{let t=(await chrome.tabs.query({active:!0}))[0].index+1;if(["image/png","image/jpeg"].includes(e.type)){let o=new FileReader;o.onload=e=>{var o;(null===(o=e.target)||void 0===o?void 0:o.result)&&chrome.storage.local.set({search_img_base64:e.target.result},()=>{chrome.tabs.create({url:a,index:t})})},o.readAsDataURL(e)}else(async function(e,t="image/png"){if(e.type!=t){const s=await createImageBitmap(e);var a=new OffscreenCanvas(s.width,s.height),o=a.getContext("2d");null==o||o.drawImage(s,0,0),e=await a.convertToBlob({type:t})}return v(e)})(e,"image/jpeg").then(e=>{chrome.storage.local.set({search_img_base64:e},()=>{chrome.tabs.create({url:a,index:t})})})})}function _(e,t){chrome.tabs.create({url:`/searchImage.html?imgSrc=${encodeURIComponent(e)}`,index:((null==t?void 0:t.index)||0)+1})}async function v(e){return new Promise(t=>{var a=new FileReader;a.onload=function(e){var a;t(null===(a=e.target)||void 0===a?void 0:a.result)},a.readAsDataURL(e)})}let y=null,R=null;function C(e,t){if(e.startsWith("data:"))return e;for(let a=0;a<t.length;a++){const o=t[a];if(o.enabled)try{if(new RegExp(o.srcPattern).test(e)){let s=e;o.replaceRules.forEach(e=>{s=s.replace(new RegExp(e.pattern,e.modifiers),e.replacement)});const[n]=t.splice(a,1);return t.unshift(n),s}}catch(e){console.error("Error applying image rule:",e,o)}}return""}async function T(e){await async function(){if(null===y||null===R){const e=await chrome.storage.local.get(["customRules_mv3","commonRules_mv3"]);y=e.commonRules_mv3||[],R=e.customRules_mv3||[]}}();const t=C(e,R);if(t&&t!==e)return t;const a=C(e,y);return a&&a!==e?a:e}chrome.storage.onChanged.addListener(e=>{e.commonRules_mv3&&(y=e.commonRules_mv3.newValue||[]),e.customRules_mv3&&(R=e.customRules_mv3.newValue||[])});const D=e=>`isTaskRunning_${e}`,I=e=>`tabQueue_${e}`,L={isRunning:async e=>(await chrome.storage.session.get(D(e)))[D(e)]||!1,setRunning:(e,t)=>chrome.storage.session.set({[D(e)]:t}),getQueue:async e=>(await chrome.storage.session.get(I(e)))[I(e)]||[],setQueue:(e,t)=>chrome.storage.session.set({[I(e)]:t}),dequeue:async e=>{const t=await L.getQueue(e),a=t.shift();return await L.setQueue(e,t),a}},O=async e=>(await chrome.tabs.query({url:chrome.runtime.getURL("output.html"),windowId:e}))[0];chrome.tabs.onRemoved.addListener(function(e,t){chrome.storage.session.get("outputTabs",a=>{const o=(a.outputTabs||{})[`t_${t.windowId}`],s=t.windowId;e===o&&(L.setRunning(s,!1),L.setQueue(s,[]),chrome.storage.session.remove(`lastImages_${s}`),console.log(`Cleared lastImages for window ${s} due to output page closure.`))})});const S=async e=>{let t=await O(e);if(t&&t.id)return"complete"!==t.status&&await(a=t.id,new Promise(e=>{const t=(o,s)=>{o===a&&"complete"===s.status&&(chrome.tabs.onUpdated.removeListener(t),e())};chrome.tabs.onUpdated.addListener(t)})),t;var a;const o=await chrome.tabs.create({url:"output.html",windowId:e});if(!o.id)throw new Error("Failed to create output tab with an ID.");const s=o.id,n=(await chrome.storage.session.get("outputTabs")).outputTabs||{};return n[`t_${e}`]=s,await chrome.storage.session.set({outputTabs:n}),await(e=>new Promise(t=>{const a=(o,s)=>{var n;"PAGE_READY"===o.type&&(null===(n=s.tab)||void 0===n?void 0:n.id)===e&&(chrome.runtime.onMessage.removeListener(a),t())};chrome.runtime.onMessage.addListener(a)}))(s),await chrome.tabs.get(s)},A=async(e,t)=>{const a=await O(e);(null==a?void 0:a.id)&&chrome.tabs.sendMessage(a.id,{type:"update_imgs",imgs:t})},U=async e=>{const t=await L.dequeue(e);if(!t)return console.log(`All tabs processed for window ${e}!`),void await L.setRunning(e,!1);try{await chrome.tabs.update(t,{active:!0}),await new Promise(e=>setTimeout(e,100));const{smartRules:e}=await chrome.storage.local.get("smartRules"),a=await chrome.tabs.get(t),o=(e||[]).find(e=>{var t;return null===(t=a.url)||void 0===t?void 0:t.match(e.reg)});let s={};o&&!o.enableIframe&&(s.frameId=0),chrome.tabs.sendMessage(t,{type:"get_imgs"},s)}catch(a){console.error(`Failed to process tab ${t}:`,a),U(e)}},M=async e=>{if(!e||0===e.length)return;const t=e[0].windowId;if(await L.isRunning(t)){console.log(`Task is already running for window ${t}.`);const e=await O(t);return void((null==e?void 0:e.id)&&await chrome.tabs.update(e.id,{active:!0}))}await L.setRunning(t,!0),console.log(`Starting image collection for window ${t}...`);const a=e.filter(e=>e.id).map(e=>e.id);await L.setQueue(t,a),console.log(`Tab queue created for window ${t}:`,a),await S(t),U(t)},E=async()=>{var e;const t=await chrome.tabs.query({active:!0,currentWindow:!0});(null===(e=t[0])||void 0===e?void 0:e.url)&&(g([{name:"dl_domain",params:{domain:new URL(t[0].url).hostname,url:t[0].url}}]),await M(t))},k=async()=>{const e=await chrome.tabs.query({url:["http://*/*","https://*/*"],windowType:"normal",currentWindow:!0});await M(e)},x=[a,o],N=[{id:a,contexts:["all"]},{id:o,contexts:["image"]}];function P(e){for(const t of x){const a=e.contextMenus.find(e=>e.id===t),o=!a||a.visible;chrome.contextMenus.update(t,{visible:o})}}function B(){chrome.storage.local.get(t,e=>{P({...h,...e[t]||{}})})}const $={[s]:e=>b(e,"1688-cross"),[n]:e=>b(e,"alibaba"),[r]:e=>b(e,"aliexpress"),[i]:e=>b(e,"taobao"),[c]:e=>b(e,"baidu"),[l]:e=>b(e,"google")};const F=e=>new Promise(t=>setTimeout(t,e));function j(e){return!!e.url&&/^(http|ftp)/.test(e.url)&&!/chrome\.google\.com\/webstore|microsoftedge\.microsoft\.com\/addons/.test(e.url)}async function G(e){try{await chrome.scripting.executeScript({target:{tabId:e,allFrames:!0},files:["contentScript.bundle.js"]}),await chrome.scripting.executeScript({target:{tabId:e},files:["pageScript.bundle.js"],world:"MAIN"})}catch(t){console.warn(`Could not inject script into tab ${e}:`,t)}}function q(e){return e&&"object"==typeof e&&!Array.isArray(e)}function V(e,t){if(!q(e)||!q(t))return t;const a={...e};for(const e in t)if(Object.hasOwn(t,e)){const o=t[e],s=a[e];if(q(o))q(s)?a[e]=V(s,o):a[e]=V({},o);else if(Array.isArray(o))if(Array.isArray(s)){const t=[...s];o.forEach(e=>{if(q(e)&&void 0!==e.id){const a=t.findIndex(t=>t.id===e.id);a>-1?t[a]=V(t[a],e):t.push(e)}else t.push(e)}),a[e]=t}else a[e]=[...o];else void 0!==o&&(a[e]=o)}return a}async function W(){const e=await chrome.storage.local.get(t),a=V(h,e[t]||{});chrome.storage.local.set({[t]:a}),g([{name:"appconfig",params:Y(a)}]);p("https://assets.fatkun.net/")}let Q=!1,z=[];async function J(){const e=chrome.runtime.getURL("output.html"),[t]=await chrome.tabs.query({url:`${e}*`});if(t)return t;if(!Q){Q=!0;try{return await chrome.tabs.create({url:e})}finally{Q=!1}}}async function H(e){const t=await J();(null==t?void 0:t.id)?chrome.tabs.sendMessage(t.id,{...e,from:"bg"},t=>{!chrome.runtime.lastError&&t||z.push(e)}):z.push(e)}function Y(e){const t={};for(const a in e)if(Object.hasOwn(e,a))if("object"==typeof e[a]&&null!==e[a]){const o=Y(e[a]);for(const e in o)Object.hasOwn(o,e)&&(t[`${a}_${e}`]=o[e])}else t[a]=e[a];return t}chrome.runtime.onMessage.addListener((a,o,s)=>{const{tab:n}=o;switch(a.type){case"COLLECT_CURRENT_TAB":return E(),!1;case"COLLECT_ALL_TABS":return k(),!1;case"FINISHED_COLLECTING_TAB":return n&&(async(e,t)=>{const a=t.windowId,o=e.map(e=>({img:e,tab:t}));await A(a,o);const s=await O(a);(null==s?void 0:s.id)&&await chrome.tabs.update(s.id,{active:!0}),U(a)})(a.imgs,n),!1;case"ADD_IMGS_TO_OUTPUT":return n&&(async(e,t)=>{const a=t.windowId;await S(a);const o=e.map(e=>({img:e,tab:t}));A(a,o)})(a.imgs,n),!1}return(async()=>{let r;switch(a.cmd){case"CMD_FROM_CT_IMGS":if(n){const t=a.data.map(e=>({img:e,tab:n}));H(new f(e,t))}break;case"CMD_OPEN_OUTPUT4_CURRENT_TAB":await J();break;case"CMD_FROM_CT_DOWNLOAD_BY_DRAG":if(n){const o=await chrome.storage.local.get(t);"filter"==={...h,...o[t]||{}}.dragTo&&H(new f(e,[{img:a.data,tab:n}]))}break;case"CMD_FROM_CT_FETCH":r=await fetch(a.url,a.settings).then(e=>e.text());break;case"CMD_SILENT_DOWNLOAD":!async function(e){for(const t of e)chrome.downloads.download({url:await T(t.url),filename:t.filename})}(a.data);break;case"CMD_CONVERT_IMG":r=await async function(e,t="image/png"){var a=await fetch(e).then(e=>e.blob());if(a.type!=t){const e=await createImageBitmap(a);var o=new OffscreenCanvas(e.width,e.height),s=o.getContext("2d");null==s||s.drawImage(e,0,0),a=await o.convertToBlob({type:t})}return w(a)}(a.data.img,a.data.type);break;case"CMD_URL_TO_DATA_URI":r=await async function(e){try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok.");const a=await t.blob();return{data:await new Promise((e,t)=>{const o=new FileReader;o.onloadend=()=>e(o.result),o.onerror=t,o.readAsDataURL(a)})}}catch(e){return console.error("Failed to fetch data URI:",e),{error:"Failed to fetch data URI"}}}(a.data.url);break;case"CMD_OUTPUT_READY":(null==n?void 0:n.id)&&(z.forEach(e=>chrome.tabs.sendMessage(n.id,e)),z=[]);break;case"CMD_SIDEPANEL_OPEN":if(await chrome.permissions.contains({permissions:["sidePanel"]})){await chrome.sidePanel.setOptions({path:`sidepanel.html?id=${a.data.id}`});const e=await chrome.windows.getCurrent();e.id&&await chrome.sidePanel.open({windowId:e.id})}else chrome.tabs.create({url:chrome.runtime.getURL("sidepanel.html")});break;case"CMD_OPEN_TAB":chrome.tabs.create({url:a.data.url});break;case"CMD_GA":g(a.data);break;case"insert-css":(null==n?void 0:n.id)&&void 0!==o.frameId&&chrome.scripting.insertCSS({target:{tabId:n.id,frameIds:[o.frameId]},files:a.data.files})}r&&s({data:r,cb:a.cb})})(),!0}),chrome.runtime.onStartup.addListener(W),chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason&&(await p(chrome.runtime.getURL("")),g([{name:"install",params:{action:e.reason}}]),chrome.tabs.query({},async e=>{for(const t of e)t.id&&j(t)&&(await G(t.id),await F(100))})),W()}),chrome.commands.onCommand.addListener(async(e,t)=>{var a,o,s;switch(e){case"CMD_DOWNLOAD_CURRENT_TAB":E();break;case"CMD_DOWNLOAD_ALL_TABS":k();break;case"CMD_OUTPUT_DOWNLOAD":case"CMD_OUTPUT_SELECT_ALL":case"CMD_OUTPUT_SELECT_TOGGLE":(null===(a=t.url)||void 0===a?void 0:a.startsWith(chrome.runtime.getURL("output.html")))&&H(new f(e));break;case"CMD_SEARCH_EC":(null===(s=null===(o=(await chrome.tabs.query({active:!0,currentWindow:!0}))[0])||void 0===o?void 0:o.url)||void 0===s?void 0:s.includes(chrome.runtime.getURL("newtab.html")))||chrome.tabs.create({url:"/newtab.html?action=ec_search"})}g([{name:"shortkey",params:{action:e}}])}),chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.removeAll(()=>{!function(){for(const e of N)chrome.contextMenus.create({id:e.id,contexts:e.contexts,title:chrome.i18n.getMessage(e.id)})}(),B()})}),chrome.runtime.onStartup.addListener(()=>{B()}),chrome.contextMenus.onClicked.addListener(async e=>{const{menuItemId:t,srcUrl:s}=e;let n=!0;if(t===a)E();else if(t===o&&s){const e=chrome.runtime.getURL(`/searchImage.html?imgSrc=${encodeURIComponent(await T(s))}`);chrome.tabs.create({url:e})}else s&&$[t]?$[t](s):n=!1;n&&g([{name:"contextmenu",params:{action:t}}])}),chrome.storage.onChanged.addListener(e=>{e[t]&&P({...h,...e[t].newValue||{}})}),chrome.runtime.onMessage.addListener((e,t,a)=>{var o;console.log("Background Service Worker received message:",e.action,e);const s=null===(o=t.tab)||void 0===o?void 0:o.id;if(void 0!==s){if("simg_initiateCapture"===e.action&&e.area){const a=e.area;return console.log(`Background: Initiating capture for tab ${s} at area`,a),chrome.tabs.captureVisibleTab(o=>{chrome.runtime.lastError?console.error("Background: Error capturing tab:",chrome.runtime.lastError.message):o?(console.log("Background: Capture successful. Sending image data to content script for cropping."),async function(e,t,a,o){console.log("Attempting to crop image using OffscreenCanvas...");try{const s=await fetch(e),n=await s.blob(),r=await createImageBitmap(n),i=new OffscreenCanvas(t.width,t.height),c=i.getContext("2d");if(!c)return console.error("Failed to get 2D context for OffscreenCanvas."),o(null),void r.close();c.drawImage(r,t.x*a,t.y*a,t.width*a,t.height*a,0,0,t.width,t.height);const l=await i.convertToBlob({type:"image/png"}),m=new FileReader;m.onload=()=>{console.log("Cropping complete with OffscreenCanvas."),o(m.result)},m.onerror=e=>{console.error("FileReader failed to convert cropped blob to Data URL:",e),o(null)},m.readAsDataURL(l)}catch(e){console.error("Error during the OffscreenCanvas cropping process:",e),o(null)}}(o,a,e.dpr,e=>{e&&(console.log("Background: Cropping successful, sending cropped image data back to content script."),_(e,t.tab))})):console.error("Background: Failed to capture tab: dataUrl is empty.")}),!0}if("searchImage"===e.action&&e.imgSrc)return _(e.imgSrc,t.tab),!0;console.warn("Background: Received unrecognized message:",e.action)}else console.error("Received message but sender tab ID is missing.")}),function e(t){chrome.storage.local.get(["simgConfigV2"]).then(a=>{a.simgConfigV2||(e(t),chrome.storage.local.set({simgConfigV2:t}))})}({sites:[],simg_site:"1688-imageId",dlDir:m,soutuDomain:"fanli.fatkun.net"}),chrome.storage.session.setAccessLevel({accessLevel:"TRUSTED_AND_UNTRUSTED_CONTEXTS"})})();