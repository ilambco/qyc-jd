(()=>{"use strict";var e,t,r,o={25141:(e,t,r)=>{r(55325);var o=r(96540),n=r(5338),a=r(29100),i=r(48742),l=r(53830),s=r(35124),c=r(15548),g=r(66423),m=r(90972),d=r(63518),u=r(79239),h=r(3797);function f({activeImgId:e,onActived:t,onDelete:r}){const[n,i]=(0,o.useState)([]),[l,s]=(0,o.useState)({});return(0,o.useEffect)(()=>{const e=e=>{e.img_search_history&&n&&i(e.img_search_history.newValue)};return chrome.storage.local.onChanged.addListener(e),()=>{chrome.storage.local.onChanged.removeListener(e)}}),(0,o.useEffect)(()=>{if(n&&n.length>0){const e=n.map(e=>e.id);chrome.storage.local.get(e,e=>{s(e),chrome.runtime.lastError&&console.error("Error fetching image srcs:",chrome.runtime.lastError)})}else s({})},[n]),(0,o.useEffect)(()=>{chrome.storage.local.get("img_search_history",e=>{i(e.img_search_history||[])})},[]),o.createElement(a.A,{sx:{display:"flex",justifyContent:"center",gap:1}},n&&n.length>0?n.map(i=>{const s=l[i.id];return s?o.createElement(a.A,{key:i.id,component:"div",onClick:()=>{t(i.id)},sx:{border:"2px solid",borderColor:e==i.id?u.A[500]:h.A[200],borderRadius:"4px",overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",position:"relative",width:"60px",height:"60px","&:hover .delete":{display:"block"}}},o.createElement("img",{key:i.id,src:s,alt:`Image history item ${i.id}`,style:{maxWidth:"100%",maxHeight:"100%"}}),o.createElement(d.A,{component:"svg",onClick:e=>{chrome.storage.local.set({img_search_history:n.filter(e=>e.id!=i.id)}),chrome.storage.local.remove(i.id),r(i.id),e.preventDefault(),e.stopPropagation()},className:"delete",sx:{position:"absolute",right:0,top:0,fontSize:"12px",background:"#fff",borderRadius:"12px",display:"none",color:"#000"}})):null}):o.createElement("p",null,"No image history found."))}var p=r(21187),v=r(78291),y=r(5076),b=r(4126),w=r(73533);const x=r.p+"9d4b840c3839929e9ce4.svg";function E({onChoosed:e}){const{t,i18n:r}=(0,v.Bd)(),n=o.useRef(null),[l,c]=o.useState(!1),[g,m]=o.useState(null);return(0,o.useEffect)(()=>{console.log(l)}),o.createElement(a.A,{onDragOver:e=>{e.preventDefault()},onDragEnter:()=>{c(!0)},onDragEnd:()=>{c(!1)},onDrop:async t=>{t.preventDefault(),c(!1);let r=t.dataTransfer.files[0];e(r)},sx:{p:3,backgroundColor:h.A[50],border:"1px dashed",borderColor:h.A[400],borderRadius:2,display:"flex",flexDirection:"column",gap:2,position:"relative"},className:"popup-content"},o.createElement(a.A,null,o.createElement(a.A,{sx:{display:"flex",alignItems:"center",gap:2,justifyContent:"center",height:"160px"}},o.createElement("img",{src:x,alt:""}),o.createElement(s.A,null,t("Drag an image here or")," ",o.createElement(y.A,{onClick:e=>{var t;null===(t=n.current)||void 0===t||t.click(),e.preventDefault(),e.stopPropagation()},sx:{cursor:"pointer",textDecoration:"none","&:hover":{textDecoration:"underline"}}},t("upload a file"))),o.createElement("input",{onChange:t=>{let r=t.target.files?t.target.files[0]:null;r&&(t.preventDefault(),e(r))},ref:n,style:{display:"none"},type:"file"}))),o.createElement(a.A,{sx:{display:"flex",alignItems:"center",gap:2}},o.createElement(a.A,{sx:{borderTop:"1px solid #ccc",flexGrow:1,height:0}}),o.createElement(s.A,null,t("OR")),o.createElement(a.A,{sx:{borderTop:"1px solid #ccc",flexGrow:1,height:0}})),o.createElement(a.A,{sx:{display:"flex",alignItems:"center",gap:1}},o.createElement(b.A,{value:g||"",onChange:e=>{m(e.target.value)},onKeyDown:t=>{"Enter"===t.key&&(t.preventDefault(),g&&fetch(g).then(t=>{t.ok?t.blob().then(t=>{e(new File([t],"image.png",{type:"image/png"}))}):console.error("Image URL is not valid:",g)}).catch(e=>{console.error("Error fetching image:",e)}))},fullWidth:!0,placeholder:t("Paste image link"),size:"small",sx:{backgroundColor:"white","& .MuiInputBase-root":{borderRadius:6}}}),o.createElement(i.A,{onClick:()=>{g&&fetch(g).then(t=>{t.ok?t.blob().then(t=>{e(new File([t],"image.png",{type:"image/png"}))}):console.error("Image URL is not valid:",g)}).catch(e=>{console.error("Error fetching image:",e)})},sx:{borderRadius:6,textTransform:"none"},variant:"outlined"},t("Search"))),o.createElement(a.A,{onDragOver:e=>{e.preventDefault()},onDragEnter:()=>{c(!0)},onDragEnd:()=>{c(!1)},onDragLeave:()=>{c(!1)},onDrop:async t=>{t.preventDefault(),c(!1);let r=t.dataTransfer.files[0];e(r)},sx:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:l?w.A[50]:"transparent",zIndex:1,display:"flex",alignItems:"center",justifyContent:"center",borderRadius:2,transition:"background-color 0.3s ease",fontSize:"16px",fontWeight:"bold",color:h.A[700],pointerEvents:l?"auto":"none"}},l?t("Drop an image here"):""))}r(18684);var A=r(96977);document.title=chrome.i18n.getMessage("ext_name")||"Search Image";let _=window.document.querySelector("#app-container");if(_){const e=(0,n.H)(_),t=new URL(location.href);e.render(o.createElement(function({imgId:e,imgSrc:t}){const{t:r}=(0,v.Bd)(),[n,d]=(0,o.useState)(null),[u,h]=(0,o.useState)(e||""),y=!!e||!!t;return(0,o.useEffect)(()=>{y?(async()=>{if(e)console.log(`Loading imgId: ${e}`),chrome.storage.local.get(e,t=>{console.log(`chrome.storage.local.get result for ${e}:`,t),t[e]?d(t[e]):(console.log(`imgId ${e} not found in storage, setting imgUrl to ''`),d(""))});else if(t){console.log(`Loading imgSrc: ${t}`);try{const e=await(0,m.xf)(t,"image/jpeg");console.log(`Loaded dataUri from imgSrc: ${e.substring(0,50)}...`),d(e);const r=await(0,m.DB)(e);console.log(`Saved imgSrc history with id: ${r}`),h(r)}catch(e){console.error("Failed to load imgSrc:",e),d("")}}else console.log("No imgId or imgSrc, setting imgUrl to '' immediately."),d("")})():d("")},[]),(0,o.useEffect)(()=>{u?chrome.storage.local.get(u,e=>{e[u]&&d(e[u])}):d("")},[u]),null!=n&&o.createElement(a.A,{sx:{userSelect:"none",display:"flex",flexDirection:"column",height:"100vh"}},n?o.createElement(p.A,{imgs:[{dataUri:n,url:t}],backButton:o.createElement(i.A,{onClick:()=>{d(""),h(""),history.pushState({},"","/searchImage.html")}},r("simg_re_select"))}):o.createElement(a.A,null,o.createElement(a.A,{sx:{p:2}},o.createElement(l.A,{direction:"row",spacing:1,sx:{alignItems:"center"}},o.createElement("img",{style:{width:36,height:36},src:(0,m.vO)(),alt:""}),o.createElement(s.A,{sx:{whiteSpace:"nowrap"},variant:"h6"},chrome.i18n.getMessage("ext_name")))),o.createElement(c.A,null),o.createElement(g.A,{sx:{userSelect:"none",mt:2,flex:1}},o.createElement(E,{onChoosed:async e=>{const t=await(0,m.as)(e);d(t),(0,m.DB)(t).then(e=>{h(e),history.pushState({},"",`/searchImage.html?imgId=${e}`)})}})),o.createElement(a.A,{sx:{p:2}},o.createElement(f,{activeImgId:u,onActived:e=>{h(e),history.pushState({},"",`/searchImage.html?imgId=${e}`)},onDelete:e=>{e==u&&d("")}}))))},{imgId:t.searchParams.get("imgId")||"",imgSrc:t.searchParams.get("imgSrc")||""}))}(0,A.V)([{name:"search_img_pageview",params:{action:"page1"}}])},90972:(e,t,r)=>{async function o(e){const t=await chrome.storage.local.get("simgConfigV2");if(t.simgConfigV2&&t.simgConfigV2.sites){const r=t.simgConfigV2.sites.find(t=>t.id==e);if(r&&r.url)return r.url}let r="";return"1688"==e?r="https://www.1688.com":"alibaba"==e?r="https://offer.alibaba.com/cps/hfj5ca47?bm=cps&src=saf&pid=image-search":"aliexpress"==e?r="https://s.click.aliexpress.com/e/_opFB1sj":"taobao"==e?r="https://www.taobao.com":"s.taobao"==e?r="https://s.taobao.com/search":"baidu"==e?r="https://www.baidu.com/":"google"==e?r="https://www.google.com/":"madeInChina"==e?r="https://www.made-in-china.com":"vvic"==e?r="https://tusou.vvic.com/":"bing"==e&&(r="https://www.bing.com/"),r}async function n(e){let t=await async function(e){let t=e;e.includes(",")&&(t=e.split(",")[1]);const r=atob(t),o=new Array(r.length);for(let e=0;e<r.length;e++)o[e]=r.charCodeAt(e);const n=new Uint8Array(o),a=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")}(e);return await chrome.storage.local.set({[t]:e}),chrome.storage.local.get("img_search_history",e=>{let r=(e.img_search_history||[]).filter(e=>e.id!=t);r.unshift({id:t,time:Date.now()}),chrome.storage.local.remove(r.slice(10).map(e=>e.id)),chrome.storage.local.set({img_search_history:r.slice(0,10)})}),t}async function a(e){return new Promise((t,r)=>{const o=new FileReader;o.readAsDataURL(e),o.onload=()=>t(o.result),o.onerror=r})}async function i(e,t="image/png"){var r=await fetch(e).then(e=>e.blob());if(r.type!=t){const e=await createImageBitmap(r);var o=new OffscreenCanvas(e.width,e.height),n=o.getContext("2d");null==n||n.drawImage(e,0,0),r=await o.convertToBlob({type:t})}return l(r)}async function l(e){return new Promise(t=>{var r=new FileReader;r.onload=function(e){var r;t(null===(r=e.target)||void 0===r?void 0:r.result)},r.readAsDataURL(e)})}function s(){const e=chrome.runtime.getManifest().icons;return e?e[128]:""}r.d(t,{DB:()=>n,R_:()=>o,as:()=>a,vO:()=>s,xf:()=>i})}},n={};function a(e){var t=n[e];if(void 0!==t)return t.exports;var r=n[e]={id:e,exports:{}};return o[e](r,r.exports,a),r.exports}a.m=o,e=[],a.O=(t,r,o,n)=>{if(!r){var i=1/0;for(g=0;g<e.length;g++){for(var[r,o,n]=e[g],l=!0,s=0;s<r.length;s++)(!1&n||i>=n)&&Object.keys(a.O).every(e=>a.O[e](r[s]))?r.splice(s--,1):(l=!1,n<i&&(i=n));if(l){e.splice(g--,1);var c=o();void 0!==c&&(t=c)}}return t}n=n||0;for(var g=e.length;g>0&&e[g-1][2]>n;g--)e[g]=e[g-1];e[g]=[r,o,n]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},r=Object.getPrototypeOf?e=>Object.getPrototypeOf(e):e=>e.__proto__,a.t=function(e,o){if(1&o&&(e=this(e)),8&o)return e;if("object"==typeof e&&e){if(4&o&&e.__esModule)return e;if(16&o&&"function"==typeof e.then)return e}var n=Object.create(null);a.r(n);var i={};t=t||[null,r({}),r([]),r(r)];for(var l=2&o&&e;("object"==typeof l||"function"==typeof l)&&!~t.indexOf(l);l=r(l))Object.getOwnPropertyNames(l).forEach(t=>i[t]=()=>e[t]);return i.default=()=>e,a.d(n,i),n},a.d=(e,t)=>{for(var r in t)a.o(t,r)&&!a.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.j=7962,a.p="/",(()=>{var e={7962:0};a.O.j=t=>0===e[t];var t=(t,r)=>{var o,n,[i,l,s]=r,c=0;if(i.some(t=>0!==e[t])){for(o in l)a.o(l,o)&&(a.m[o]=l[o]);if(s)var g=s(a)}for(t&&t(r);c<i.length;c++)n=i[c],a.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return a.O(g)},r=self.webpackChunkfatkun_v3=self.webpackChunkfatkun_v3||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))})(),a.nc=void 0;var i=a.O(void 0,[6163,9925,7684,8742,8915,5008,8311,5728,8555,1315,3558,6859,251,6459,2076],()=>a(25141));i=a.O(i)})();